<!DOCTYPE html>
<html>
<head>
<title>Plugin test page</title>
<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<style>
body {
	padding-top: 60px;
	padding-bottom: 40px;
}
#tag {
	width: auto;
	display: table-cell;
}
.browse-button { 
    cursor: pointer;
    float: left;
    overflow: hidden;
    position: relative;
}
.browse-button input[type="button"] { 
    cursor: pointer;
}
.browse-button input[type="file"] { 
    width: 150px;
    heigth: 100px;
    position: absolute;
    right: 0px;
    top: 0px;
    cursor: pointer;
    opacity: 0;
    filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);
}
</style>
<script type="text/javascript" src="https://raw.github.com/eligrey/FileSaver.js/master/FileSaver.min.js"></script>
<script type="text/javascript" src="jquery-1.9.1.js"></script>
<script type="text/javascript" src="../taglib.js"></script>
<script type="text/javascript">
$(function() {
	$('#pluginState').html('Plugin is ' + (TagLib.isValid ? 'valid' : 'invalid'));
	
	TagLib.debug = function() { console.debug.apply(console, arguments); };

	$('#file').change(function(evt) {
		var file = evt.target.files[0];
		if (!file) {
			return;
		}
		
		TagLib.load(file, function(file) {
			var tag = file.tag();
			
			$('#tag input[name="artist"]').val(tag.artist);
			$('#tag input[name="album"]').val(tag.album);
			$('#tag input[name="title"]').val(tag.title);
			$('#tag input[name="comment"]').val(tag.comment);
			$('#tag input[name="genre"]').val(tag.genre);
			$('#tag input[name="year"]').val(tag.year);
			$('#tag input[name="track"]').val(tag.track);
			$('#tag input[name="isEmpty"]').val(tag.isEmpty());
			
			$('#save').data('file', file);
			$('#save').removeAttr('disabled');
		});
	});
	
	$('#save').click(function() {
		var file = $(this).data('file');
		var tag = file.tag();
		
		tag.artist = $('#tag input[name="artist"]').val();
		tag.album = $('#tag input[name="album"]').val();
		tag.title = $('#tag input[name="title"]').val();
		tag.comment = $('#tag input[name="comment"]').val();
		tag.genre = $('#tag input[name="genre"]').val();
		tag.year = $('#tag input[name="year"]').val();
		tag.track = $('#tag input[name="track"]').val();
		
		file.save(function(blob) {
			saveAs(blob, file.name);
		});
	});
});

// ArrayBufferStream tests
(function() {
	var arrayEquals = function(a, b) {
		if (a.length != b.length) {
			return false;
		}
		for (var i = 0; i < a.length; ++i) {
			if (a[i] != b[i]) {
				return false;
			}
		}
		return true;
	}
	
	var stream = new TagLib.ArrayBufferStream([0, 1, 2, 3, 4]);
	console.assert(stream.tell() == 0);
	stream.seek(3, 0);
	console.assert(stream.tell() == 3);
	stream.seek(1, 1);
	console.assert(stream.tell() == 4);
	stream.seek(-2, 1);
	console.assert(stream.tell() == 2);
	stream.seek(2, 2);
	console.assert(stream.tell() == 3);
	
	stream.seek(0);
	console.assert(arrayEquals(stream.readBlock(3), [0, 1, 2]));
	
	stream.seek(3);
	console.assert(arrayEquals(stream.readBlock(3), [3, 4]));
	
	stream.seek(0);
	stream.truncate(6);
	console.assert(arrayEquals(stream.readBlock(stream.length()), [0, 1, 2, 3, 4, 0]));
	
	stream.seek(0);
	stream.truncate(4);
	console.assert(arrayEquals(stream.readBlock(stream.length()), [0, 1, 2, 3]));
	
	stream = new TagLib.ArrayBufferStream([0, 1, 2, 3, 4]);
	stream.insert([10, 11], 2, 1);
	console.assert(arrayEquals(stream.readBlock(stream.length()), [3, 4]));
	stream.seek(0);
	console.assert(arrayEquals(stream.readBlock(stream.length()), [0, 1, 10, 11, 3, 4]));
	
	stream = new TagLib.ArrayBufferStream([0, 1, 2, 3, 4]);
	stream.insert([10, 11], 1, 3);
	console.assert(arrayEquals(stream.readBlock(stream.length()), [4]));
	stream.seek(0);
	console.assert(arrayEquals(stream.readBlock(stream.length()), [0, 10, 11, 4]));
})();
</script>
</head>
<body>
	<div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="https://github.com/dizel3d/taglib-js" target="_blank">TagLib Audio Meta-Data Library port for web browsers</a>
          <div class="nav-collapse collapse">
          	<div class="navbar-text pull-right" id="pluginState"></div>
          </div>
        </div>
      </div>
    </div>
	<div class="container">
		<div class="row">
			<div class="span2">
				<div class="browse-button">
					<p>
				    <input type="button" class="btn btn-primary" value="Load MPEG audio">
				    <input type="file" id="file">
				    </p>
				</div>
				<p><input id="save" disabled="disabled" class="btn" type="button" value="Save" style="width: 100%"></p>
			</div>
			<div class="span2 offset1" id="tag" align="right">
				<div>artist <input type="text" name="artist" /></div>
				<div>album <input type="text" name="album" /></div>
				<div>title <input type="text" name="title" /></div>
				<div>comment <input type="text" name="comment" /></div>
				<div>genre <input type="text" name="genre" /></div>
				<div>year <input type="text" name="year" /></div>
				<div>track <input type="text" name="track" /></div>
				<div>isEmpty <input type="text" name="isEmpty" readonly="readonly" /></div>
			</div>
			<div class="span5" align="center">
				<img style="border: 5px solid #ccc" src="taglib.png">
			</div>
		</div>
	</div>
</body>
</html>
